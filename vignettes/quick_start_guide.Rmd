---
title: "clustOpt: Quickstart Guide"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r Sys.Date()`'
vignette: >
  %\VignetteIndexEntry{clustOpt: Quickstart Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, echo=FALSE}
library(Seurat)
# Only v5 Seurat Assays are supported
options(Seurat.object.assay.version = "v5")
# Only needs to be set for analyzing large datasets
options(future.globals.maxSize = 1e9)
library(dplyr)
library(clustOpt)
library(foreach)
library(doFuture)
set.seed(1)
```

```{r load_data}
# Read in a leverage score based subsample (1% of total cells) of the AIDA dataset
input <- readRDS("../inst/extdata/1000_sketch_ROSMAP.Rds")

input <- input |>
  SCTransform(verbose = FALSE) |>
  RunPCA(verbose = FALSE)
```


```{r elbowplot}
ElbowPlot(input,ndims = 50)
```

```{r UMAP, warning=FALSE}
input <- RunUMAP(input,dims = 1:20)

DimPlot(input,
        group.by = "projid",
        pt.size = 1)
```


```{r, fig.width=15}
DimPlot(input,
        group.by = "broad.cell.type",
        label = TRUE,
        label.box = TRUE,
        repel = TRUE,
        pt.size = 2) 
```



```{r}
test_sam <- "11302830"
Seurat::DefaultAssay(input) <- "RNA"
input <- Seurat::DietSeurat(input, assays = "RNA")


test <- prep_test(input,
                  subject_ids = "projid",
                  test_id = test_sam,
                  dtype = "scRNA")
train <- prep_train(input,
                  subject_ids = "projid",
                  test_id = test_sam,
                  dtype = "scRNA")

message(paste0(
      "Found ",
      length(intersect(
        rownames(test@assays[["SCT"]]@scale.data),
        Seurat::VariableFeatures(train)
      )),
      " shared genes between testing and training data"
    ))

message(sprintf(
  "Found %d (%.2f%%) shared genes between testing and training data",
  length(intersect(
    rownames(test@assays[["SCT"]]@scale.data),
    Seurat::VariableFeatures(train)
  )),
  length(intersect(
    rownames(test@assays[["SCT"]]@scale.data),
    Seurat::VariableFeatures(train)
  )) / length(rownames(train@assays[["SCT"]]@scale.data)) * 100
))
train <- RunPCA(train)
train <- FindNeighbors(train,dims = 1:20)
train <- FindClusters(train,resolution = c(.01,.1,.2))

tmp <- project_PCA(train,test,ndim = 20)





# registerDoFuture()
# tmp <- clust_opt(input,
#                  res_range = c(.01,.1),
#                  subject_ids = "projid",
#                  plan = "multisession",
#                  ndim = 10,
#                  ncore = 4,
#                  verbose = T)



```

