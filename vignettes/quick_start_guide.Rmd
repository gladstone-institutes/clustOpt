---
title: "clustOpt: Quickstart Guide"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r Sys.Date()`'
vignette: >
  %\VignetteIndexEntry{clustOpt: Quickstart Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  dev = "png",
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  warning = FALSE,
  dpi = 300
)
```

```{r setup, message=FALSE}
library(Seurat)
# Only v5 Seurat Assays are supported
options(Seurat.object.assay.version = "v5")
# Only needs to be set for analyzing large datasets
options(future.globals.maxSize = 1e20)
library(dplyr)
library(tidyr)
library(ggplot2)
library(clustOpt)
library(future)
set.seed(42)
```

Read in the tutorial dataset. This data was generated from the [Asian Immune Diversity Atlas](https://doi.org/10.1101/2024.06.30.601119) (data freeze v1). It contains only B cells and NK cells from 20 donors which have been sketched to 1000 cells using the leverage score based method of Seurat's SketchData function.

```{r load_data}
input <- readRDS(
  system.file(
    "extdata",
    "1000_cell_sketch_10_donors_2_celltypes_AIDA.rds",
    package = "clustOpt"
  )
)
```


```{r summarize}
input@meta.data |>
  summarize(
    Donors = n_distinct(donor_id),
    Celltypes = n_distinct(broad_cell_type),
    `Cell Subtypes` = n_distinct(author_cell_type),
    Ethnicities = n_distinct(Ethnicity_Selfreported),
    Countries = n_distinct(Country)
  ) |>
  pivot_longer(cols = everything(), names_to = "Metric", values_to = "Count")
```


```{r process}
input <- input |>
  SCTransform(verbose = FALSE) |>
  RunPCA(verbose = FALSE)
```

```{r elbowplot}
ElbowPlot(input, ndims = 50)
```

```{r UMAP}
input <- RunUMAP(input, dims = 1:20, verbose = FALSE)

DimPlot(input,
  group.by = "donor_id",
  pt.size = .8
) +
  coord_fixed()
```

```{r}
DimPlot(input,
  group.by = "broad_cell_type",
  pt.size = .8
) +
  coord_fixed()
```

```{r}
DimPlot(input,
  group.by = "author_cell_type",
  pt.size = .8
) +
  coord_fixed()
```

Subject-wise cross validation is parallelized with `future` and `future.batchtools` can be used for HPC job schedulers. For details on which plan to use for your setup, see the future package documentation.

```{r clustOpt, warning=FALSE}
plan("multisession", workers = 12)

sil_dist <- clust_opt(input,
  res_range = c(
    0.02, 0.04, 0.06, 0.08, 0.1,
    0.2, 0.4, 0.6, 0.8
  ),
  subject_ids = "donor_id",
  ndim = 20,
  verbose = TRUE,
  split_method = "odd_even",
  train_with = "B"
) |>
  progressr::with_progress() # Optional, just adds progress bar

# Shut down stray workers
plan("sequential")
```

## Plotting the silhouette score distributions

```{r plotting}
plots <- create_sil_plots(sil_dist)

plots[[1]]
plots[[2]]
plots[[3]]
plots[[4]]
```

The median silhouette scores start going down at 0.06, indicating that this clustering resolution is reproducible across all biological samples. For larger datasets with more celltypes, a local maximum in the mean silhouette is a clear signal of the most reproducible resolution.

## Comparison to the cell annotations

```{r cluster}
input <- FindNeighbors(input, dims = 1:20, verbose = FALSE)
input <- FindClusters(input, resolution = 0.06)

DimPlot(input,
  group.by = "seurat_clusters",
  pt.size = .8
)
```

```{r}
# TO DO: Add a step where we evaluate this chosen resolution against the
# reference annotations using wRI and silhouette score
```

