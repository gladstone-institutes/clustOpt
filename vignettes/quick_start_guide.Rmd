---
title: "clustOpt: Quickstart Guide"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r Sys.Date()`'
vignette: >
  %\VignetteIndexEntry{clustOpt: Quickstart Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(dev = "png",
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, echo=FALSE, dpi=400}
library(Seurat)
# Only v5 Seurat Assays are supported
options(Seurat.object.assay.version = "v5")
# Only needs to be set for analyzing large datasets
options(future.globals.maxSize = 1e9)
library(dplyr)
library(clustOpt)
library(future)
set.seed(1)
```

Read in a leverage score based sketch of 5000 cells from 10 donors in the ROSMAP dataset

```{r load_data}
input <- readRDS("../inst/extdata/5000_sketch_ROSMAP.Rds")

input <- input |>
  SCTransform(verbose = FALSE) |>
  RunPCA(verbose = FALSE)
```

```{r elbowplot, cache=TRUE}
ElbowPlot(input, ndims = 50)
```

```{r UMAP, warning=FALSE}
input <- RunUMAP(input, dims = 1:20)

DimPlot(input,
  group.by = "projid",
  pt.size = .8
)
```

```{r}
DimPlot(input,
  group.by = "broad.cell.type",
  label = TRUE,
  label.box = TRUE,
  repel = TRUE,
  pt.size = .8
)
```

Model training is parallelized with `future` and `future.batchtools` can be used to parallelize training using HPC job schedulers.

```{r clustOpt}
plan("multisession", workers = 10)

sil_dist <- clust_opt(input,
  res_range = c(
    0.02, 0.04, 0.06, 0.08, 0.1,
    0.2, 0.4, 0.6, 0.8
  ),
  subject_ids = "projid",
  ndim = 20,
  verbose = F
) |> progressr::with_progress()

# Shut down stray workers
plan("sequential")
```

## Plotting the silhouette score distributions

```{r plotting}
create_sil_plots(sil_dist)
```

The local maximum in the mean silhouette scores at 0.1 indicates that this clustering resolution is the most reproducible across all biological samples.

## Comparison to the cell annotations

```{r cluster}
input <- FindNeighbors(input, dims = 1:20, verbose = F)
input <- FindClusters(input, resolution = 0.1)

DimPlot(input,
  group.by = "seurat_clusters",
  pt.size = .8
)
```
