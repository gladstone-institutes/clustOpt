---
title: "clustOpt: Quickstart Guide"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r Sys.Date()`'
vignette: >
  %\VignetteIndexEntry{clustOpt: Quickstart Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, echo=FALSE}
library(Seurat)
# Only v5 Seurat Assays are supported
options(Seurat.object.assay.version = "v5")
# Only needs to be set for analyzing large datasets
options(future.globals.maxSize = 1e9)
library(dplyr)
library(clustOpt)
library(future)
set.seed(1)
```

```{r load_data}
# Read in a leverage score based subsample (1% of total cells) of the AIDA dataset
input <- readRDS("../inst/extdata/5000_sketch_ROSMAP.Rds")

input <- input |>
  SCTransform(verbose = FALSE) |>
  RunPCA(verbose = FALSE)
```


```{r elbowplot}
ElbowPlot(input, ndims = 50)
```

```{r UMAP, warning=FALSE}
input <- RunUMAP(input, dims = 1:20)

DimPlot(input,
  group.by = "projid",
  pt.size = 1
)
```


```{r, fig.width=15}
DimPlot(input,
  group.by = "broad.cell.type",
  label = TRUE,
  label.box = TRUE,
  repel = TRUE,
  pt.size = 2
)
```



```{r}
plan("multisession", workers = 4)

sil_dist <- clust_opt(input,
  res_range = c(0.01, 0.1),
  subject_ids = "projid",
  ndim = 20,
  verbose = F
) |> progressr::with_progress()

# Shut down stray workers
plan("sequential")
```


```{r}
library(ggplot2)

# Basic plots of the sil score distribution across cells
sil_dist %>%
  ggplot(aes(x = as.factor(resolution), y = avg_width)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Resolution", y = "Avg. Silhouette Score Across All Cells")

sil_dist %>%
  ggplot(aes(x = as.factor(resolution), y = cluster_avg_widths)) +
  geom_boxplot() +
  theme_bw() +
  labs(x = "Resolution", y = "Avg. Silhouette Score Across Clusters")
```
