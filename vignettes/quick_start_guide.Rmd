---
title: "clustOpt: Quickstart Guide"
output: rmarkdown::html_vignette
date: 'Compiled: `r Sys.Date()`'
vignette: >
  %\VignetteIndexEntry{clustOpt: Quickstart Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = TRUE,
  warning = FALSE,
  fig.height = 5,
  fig.width = 8
)
```

```{r setup, message=FALSE}
library(Seurat)
# Only v5 Seurat Assays are supported
options(Seurat.object.assay.version = "v5")
# Only needs to be set for analyzing large datasets
options(future.globals.maxSize = 1e20)
library(dplyr)
library(tidyr)
library(ggplot2)
library(clustOpt)
library(future)
set.seed(42)
```

Read in the tutorial dataset. This data was generated from the [Asian Immune Diversity Atlas](https://doi.org/10.1101/2024.06.30.601119) (data freeze v1). It contains only B cells, Monocytes, and NK cells from 10 donors which have been sketched to a total of 1000 cells using the leverage score based method of Seurat's SketchData function.

```{r load_data}
input <- readRDS(
  system.file(
    "extdata",
    "1000_cell_sketch_10_donors_3_celltypes_AIDA.rds",
    package = "clustOpt"
  )
)
```


```{r summarize}
input@meta.data |>
  summarize(
    Donors = n_distinct(donor_id),
    Celltypes = n_distinct(broad_cell_type),
    `Cell Subtypes` = n_distinct(author_cell_type),
    Ethnicities = n_distinct(Ethnicity_Selfreported),
    Countries = n_distinct(Country)
  ) |>
  pivot_longer(cols = everything(), names_to = "Metric", values_to = "Count")
```


```{r process}
input <- input |>
  SCTransform(verbose = FALSE) |>
  RunPCA(verbose = FALSE)
```

```{r elbowplot}
ElbowPlot(input, ndims = 50)
```

```{r UMAP}
input <- RunUMAP(input, dims = 1:20, verbose = FALSE)

DimPlot(input,
  group.by = "donor_id",
  pt.size = .8
) +
  coord_fixed()
```

```{r}
DimPlot(input,
  group.by = "broad_cell_type",
  pt.size = .8
) +
  coord_fixed()
```

```{r}
DimPlot(input,
  group.by = "author_cell_type",label = T,
  pt.size = .8
) +
  coord_fixed()
```

Subject-wise cross validation is parallelized with `future` and `future.batchtools` can be used for HPC job schedulers. For details on which plan to use for your setup, see the future package documentation.

```{r clustOpt, warning=FALSE}
plan("multisession", workers = 10)

sil_dist <- clust_opt(input,
  subject_ids = "donor_id",
  ndim = 20,
  verbose = FALSE,
  train_with = "odd"
) |>
  progressr::with_progress() # Optional, just adds progress bar

# Shut down stray workers
plan("sequential")
```

## Plotting the silhouette score distributions

```{r plotting}
plots <- create_sil_plots(sil_dist |> drop_na())

plots[[1]]
plots[[2]]
plots[[3]]
plots[[4]]
```

The median silhouette scores across all cells have a slight local maximum at 0.08, indicating that this clustering resolution is the most reproducible across all biological replicates. In general the first local maximum that is seen is the optimal resolution.**For larger datasets with more celltypes, the local maximum in the silhouette scores should be more apparent.**

## Comparison to the cell annotations

```{r cluster}
input <- FindNeighbors(input, dims = 1:20, verbose = FALSE)
input <- FindClusters(input, resolution = 0.08)

DimPlot(input,
  group.by = "seurat_clusters",
  pt.size = .8
)
```




```{r}
# TO DO: Add a step where we evaluate this chosen resolution against the
# reference annotations using wRI and silhouette score
```

